name: Build and Upload Wheels

on:
  # TODO: remove the push one
  push:
    branches:
      - mmann/arm-lib64
  release:
    types: [published]
  schedule:
    - cron: '0 1 * * *'
  workflow_dispatch:
    inputs:
      deploy_target:
        type: choice
        description: "Choose the deployment target"
        options:
        - None
        - PyPI
        - Test PyPI

jobs:
  build_wheels:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        name: [manylinux-x86_64, manylinux-aarch64, macos-x86_64, macos-arm64]
        include:
          # - name: manylinux-x86_64
          #   os: ubuntu-latest
          #   arch: x86_64
          - name: manylinux-aarch64
            os: ubuntu-24.04-arm
            arch: aarch64
            shell: bash
          # - name: macos-x86_64
          #   os: macos-13
          #   macos-target: 13
          # - name: macos-arm64
          #   os: macos-14
          #   macos-target: 14

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # cibuildwheel requires the pyproject.toml to be present from the beginning
    - name: Place pyproject.toml
      run: |
        mkdir -p ./build/python
        cp ./python/pyproject.toml ./build/python/

    - name: Build wheels
      uses: pypa/cibuildwheel@v2.22.0
      continue-on-error: true 
      with:
        # Where the setup.py and pyproject.toml build infrastructure is
        package-dir: ./build/python
      env:
        CIBW_BUILD: "cp310-* cp311-* cp312-* cp313-*"
        CIBW_SKIP: "*-win32 *-win_amd64 *-win_arm64 *-musllinux_*"
        CIBW_ARCHS_LINUX: ${{ matrix.arch }}
        CIBW_MANYLINUX_X86_64_IMAGE: quay.io/pypa/manylinux_2_28_x86_64
        CIBW_MANYLINUX_AARCH64_IMAGE: quay.io/pypa/manylinux_2_28_aarch64
        CIBW_BEFORE_ALL_LINUX: |
          dnf install -y \
            cmake \
            gperf \
            gmp-devel \
            ninja-build \
            java-1.8.0-openjdk-devel \
            glibc-static \
            libstdc++-static
          bash {project}/ci-scripts/cibw-build-deps.sh
        CIBW_BEFORE_ALL_MACOS: |
          brew update
          brew install gperf ninja
          brew install SRI-CSL/sri-csl/libpoly
          bash {project}/ci-scripts/cibw-build-deps.sh
        CIBW_BEFORE_BUILD: >
          python3 -m pip install \
            Cython>=3.0.0 \
            meson \
            pyparsing \
            pytest \
            setuptools \
            tomli \
            wheel
          bash {project}/ci-scripts/cibw-build-before.sh
        CIBW_ENVIRONMENT_MACOS: >
          DYLD_LIBRARY_PATH="$(pwd)/install/lib:$DYLD_LIBRARY_PATH"
          MACOSX_DEPLOYMENT_TARGET=${{ matrix.macos-target }}
        CIBW_TEST_COMMAND: pytest {project}/tests

    - name: Verify wheel contents
      if: always()  # This ensures the step runs regardless of previous step success/failure
      run: |
        echo "Attempting to diagnose wheel issues..."
        ls -lR ./*
        if ls dist/*.whl &>/dev/null; then
          echo "Found wheel(s) to analyze:"
          ls -la dist/*.whl
          
          echo "Unpacking wheel contents..."
          mkdir -p wheel_contents
          unzip -l dist/*.whl || echo "Failed to list wheel contents"
          unzip -d wheel_contents dist/*.whl || echo "Failed to extract wheel"
          
          echo "Looking for Z3SolverFactory symbols..."
          find wheel_contents -name "*.so" -type f | while read so_file; do
            echo "Checking $so_file"
            nm -D "$so_file" 2>/dev/null | grep Z3SolverFactory || echo "No Z3SolverFactory symbols found in $so_file"
          done
          
          echo "Examining all libraries in the wheel..."
          find wheel_contents -name "*.so" -type f | while read so_file; do
            echo "Dependencies for $so_file:"
            ldd "$so_file" 2>/dev/null || echo "Failed to run ldd on $so_file"
          done
        else
          echo "No wheels found in dist/ directory"
          echo "Checking intermediate build directories..."
          find . -name "*.whl" -type f
          find . -path "*/wheelhouse/*" -type d -exec ls -la {} \;
          
          echo "Checking for any built libraries..."
          find ./build -name "*.so" -o -name "*.dylib" -o -name "*.dll" | while read lib; do
            echo "Found library: $lib"
            if [[ "$lib" == *"z3"* ]]; then
              echo "Z3-related library found, checking symbols:"
              nm -D "$lib" 2>/dev/null | grep Z3SolverFactory || echo "No Z3SolverFactory symbols in $lib"
            fi
          done
        fi
  
    - name: Fail if wheel build failed
      if: steps.build-wheels.outcome == 'failure'
      run: exit 1

    - name: Upload wheels to PyPI
      if: >
        github.event_name == 'release' ||
        (github.event_name == 'workflow_dispatch' &&
          github.event.inputs.deploy_target == 'PyPI')
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}
      run: |
        python3 -m venv ./upload-env
        source ./upload-env/bin/activate
        python3 -m pip install twine
        python3 -m twine upload --skip-existing wheelhouse/*.whl

    - name: Upload wheels to TestPyPI
      if: >
        github.event_name == 'push' ||
        (github.event_name == 'workflow_dispatch' &&
        github.event.inputs.deploy_target == 'Test PyPI')
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.TEST_PYPI_TOKEN }}
      run: |
        python3 -m venv ./upload-env
        source ./upload-env/bin/activate
        python3 -m pip install twine
        python3 -m twine upload --skip-existing --repository testpypi wheelhouse/*.whl
